---
title: "Homicide Rate, Suicide Rate and GDP over 50 Years"
subtitle: "Introduction to R for Data Science and Computational Social Sciences"
author: "Ursulina Kölbener, Cand. Lucerne Master in Computational Social Sciences"
date: "2022-11-18"
output: 
  rmarkdown::html_document: 
    theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



## Setup
```{r packages, echo = FALSE}
# install.packages("tidyverse")
library(tidyverse)

# install.packages("stargazer")
library(stargazer)

# install.packages("viridis")
library(viridis)
```



## 1. Dataset

The dataset contains homicide rate, suicide rate and gross domestic product (GDP) from 1970 to 2020 by country. The data source is [THE WORLD BANK](https://data.worldbank.org/).

```{r import data}
# import dataset
shg_original <- rio::import("data/suicide_homicide_gdp.csv")

```

There are 13'566 observations with 10 variables. The country name is represeneted in three different ways. Once completely written out («country»), once abbreviated according to the iso standard with 3 characters («iso3c») and once abbreviated according to the iso standard with 2 characters («iso2c»).

```{r observations and variables}
# number of observations
nrow(shg_original)

# numer of variables
ncol(shg_original)

```

The dataset shows observations from 1970 to 2020 («year») as a integer data type. Further there are four numerical values: «Intentional homicides (per 100,000 people)», «Suicide mortality rate (per 100,000 population)», Gross Domestic Product «GDP (current USD)» and «GDP per capita, PPP (current international $)». Intentional homicides and suicide mortality rate are discrete values. Gross domestic product (GDP) is a continuous variable, a monetary measure of the market value of all the final goods and services produced and sold (not resold) in a specific time period by countries. Gross domestic product (GDP) per capita is a financial metric that breaks down a country's economic output per person and is calculated by dividing the GDP of a nation by its population. The values of the GDP per capita reach from 285.4 to 153563.9.

Finally, the region («adminregion») and income level («incomeLevel») are specified as characters. Region and income level are categorical variables. Income level is somewhat ordinal with the following values: Aggregates, High income, Low income, Lower middle income and Upper middle income. A few variables are not classified, others are aggregates. I will remove them later.

```{r data type and summary}
# check data type of every variable
str(shg_original)

# summary statistics
summary(shg_original)

```

#### Research Questions

Do intentional homicides correlate with gross domestic product (GDP) in genereal? What are the differences in regions over the years?

Does a high homicide rate favor a high suicide mortality rate?

## 2. Summary Statistics

Transforming the data for easier handling. Also, the dataset contains lot's of variables with NA. Removing those NA's leaves 2352 observations.

```{r easy transformation}
# creating a new dataset from the original data
shg <- shg_original

# renaming the variables to easier names
shg <- rename(shg, IntHomicides = `Intentional homicides (per 100,000 people)`,
              SuicideMort = `Suicide mortality rate (per 100,000 population)`,
              GDP = `GDP (current US$)`,
              GDPcap = `GDP per capita, PPP (current international $)`,
              region = `adminregion`)

# removing all observations with NA's
shg <- shg %>% 
  filter(incomeLevel != "Aggregates" & incomeLevel != "Not classified" ) %>% 
  filter(!is.na(IntHomicides)) %>% 
  filter(!is.na(SuicideMort))

```


For the *income level*: There are 897 observations with high income, 757 with upper middle income, 560 with lower middle income and 132 observations with low income.

```{rfrequency table}
# calculate frequency of income level
table(shg$incomeLevel)

```

GDP per capita: The minimum value is 532.5 and the maximum 141634.7. The mean has a value of 19491.1, the medain is lower at 12506.5.

```{r summary}
# summary of GDP per capita
summary(shg$GDPcap)
```



## 3. Data Transformation

The column «iso3c» is not necessary. Further I discovered a few total rows in between the rest of the data.

```{r}
# create a new subset
shg_trnsf <- shg %>% 
  select(-iso3c) %>% # remove column iso3c
  filter(iso2c != "") # remove rows (total per region)

```


As the regions in the dataset are incomplete and do not match the ISO standard, I imported a proper list («region») with countries and their regions. I merged the two tables together. I used `merge`as I could not figure it out with `inner_join`.

```{r}
# import a second dataset
region <- rio::import("data/region.csv")

# rename columns for easier merging
region <- rename(region, iso2c = `alpha-2`,
                 regionISO = `region`)

# combining another dataset
shg_exp <- merge(x = shg_trnsf, y = region, by = "iso2c")

```


## 4. Data Vizualization
Firstly, I'd like to show the general global trend from GDP per capita, Intentional Homicides and Suicide Mortality by region.

```{r trend by region and year}
# calculate the sum of two continuous variables and the average of one
shg_trend <- shg_exp %>% 
  group_by(regionISO, year) %>% 
  summarise(sum_IntHomicides = sum(IntHomicides, na.rm = TRUE),
            sum_SuicideMort = sum(SuicideMort, na.rm = TRUE),
            avg_GDPcap = mean(GDPcap, na.rm = TRUE))

# show summarized data
shg_trend

```

```{r}
# plot Global Trend in Global Trend in GDP per Capita" 
ggplot(data = shg_trend) +
  geom_line(mapping = aes(x = year, y = avg_GDPcap, 
                          colour = regionISO, 
                          group = regionISO), 
            size = 1.3) +
  theme_light() +
  scale_color_viridis(discrete = TRUE) +
  labs(x = "year", y = "GDP per capita (current international $)",
       colour = "Region",
       title = "Global Trend in GDP per Capita by Region",
       subtitle = "",
       caption = "Data from the world bank.")
  
```

```{r}
# plot Global Trend in Intentional Homicides 
ggplot(data = shg_trend) +
  geom_line(mapping = aes(x = year, y = sum_IntHomicides, 
                          colour = regionISO, group = regionISO), size = 1.3) +
  theme_light() +
  scale_color_viridis(discrete = TRUE) +
  labs(x = "year", 
       y = "Intentional homicides (per 100,000 people)",
       colour = "Region",
       title = "Global Trend in Intentional Homicides by Region",
       subtitle = "",
       caption = "Data from the world bank.")
  
```

```{r}
# plot Global Trend in Global Trend in Suicide Mortality Rate 
ggplot(data = shg_trend) +
  geom_line(mapping = aes(x = year, y = sum_SuicideMort, 
                          colour = regionISO, 
                          group = regionISO), 
            size = 1.3) +
  theme_light() +
  scale_color_viridis(discrete = TRUE) +
  labs(x = "year", 
       y = "Suicide mortality rate (per 100,000 population)",
       colour = "Region",
       title = "Global Trend in Suicide Mortality Rate by Region",
       subtitle = "",
       caption = "Data from the world bank.")
  
```

```{r}
# plot Global Trend 
ggplot(data = shg_trend, mapping = aes(x = year)) +
  geom_line(mapping = aes(y = sum_IntHomicides), colour = "#33638DFF", size = 1.2) +
  geom_line(mapping = aes(y = sum_SuicideMort), colour = "#29AF7FFF", size = 1.2) +
  theme_light() +
  scale_color_viridis(discrete = TRUE) +
  facet_wrap(~ regionISO) +
  labs(x = "year", y = "cases per 100,000 population", 
       title = "Global Trend in Suicide Mortality Rate and Intended Homicides",
       subtitle = "",
       caption = "Data from the world bank.")
  
```

```{r, echo = FALSE}
# ....
ggplot(data = shg_exp) +
  geom_point(mapping = aes(x = log(GDPcap), y = IntHomicides),)+
  geom_smooth(mapping = aes(x = log(GDPcap), y = IntHomicides), method = "lm")+
  facet_wrap (~ regionISO, scales = "free") +
  theme_light()

```

```{r}
# create a subset
shg_2018 <- shg_exp %>%
  filter(year == 2018) %>% # only observations from 2018
  group_by(`sub-region`, regionISO) %>% # grouped by sub-region and region (for colour fill)
  summarise(sumSuicideMort = sum(SuicideMort)) %>% # calculate sum
  arrange(desc(sumSuicideMort)) # order descending

# create plot
ggplot(shg_2018) +
  geom_col(mapping = aes(x = reorder(`sub-region`, desc(sumSuicideMort)), 
                         y = sumSuicideMort, fill = regionISO)) + 
  theme_light() +
  scale_fill_viridis(discrete = TRUE) +
  labs(x = "" , 
       y = "Suicide mortality rate", 
       fill = "Region",
       title = "Suicide Mortality Rate by sub-regions",
       subtitle = "",
       caption = "Data from the world bank.") +
  theme(axis.text.x = element_text(angle = 70, hjust = 1))

```

```{r}
# create a subset
shg_2018_top20 <- shg_exp %>%
  filter(year == 2018) %>% # only observations from 2018
  arrange(desc(SuicideMort)) %>% # order descending
  top_n(20, SuicideMort) # keep only top 20

# create plot
ggplot(shg_2018_top20) +
  geom_col(mapping = aes(x = reorder(country, desc(SuicideMort)), 
                         y = SuicideMort, fill = regionISO)) + 
  theme_light() +
  scale_fill_viridis(discrete = TRUE) +
  labs(x = "" , y = "Suicide mortality rate", 
       title = "Top 20 Countries by Suicide Mortality Rate",
       fill = "Region",
       subtitle = "",
       caption = "Data from the world bank.") +
  theme(axis.text.x = element_text(angle = 70, hjust = 1))

```

#### Boxplot
I am using income level as the horizontal variable for a boxplot. This results in the creation of a separate boxplot for each level of income. All the observation with a category "high income" are used in the leftmost boxplot. Similarly the observations for levels "low income", "lower middle income" and "upper middle income" are used in separate boxplots.

```{r}
ggplot(shg_exp) +
  geom_boxplot(mapping = aes(x = incomeLevel, y = IntHomicides)) +
  ylim(0, 60) +
  theme_light() +
  labs(x = "Income Level" , y = "Intended Homicides", 
       title = "Top 20 Countries by Suicide Mortality Rate",
       subtitle = "",
       caption = "Data from the world bank.")
```

## 5. Statistical Modelling
```{r}


# study Suicide Mortality Rate
fit1 <- lm(formula = SuicideMort ~ IntHomicides * GDPcap, 
           data = shg_exp)

fit2 <- lm(formula = SuicideMort ~ incomeLevel,
           data = shg_exp)

fit3 <- lm(formula = SuicideMort ~ regionISO + GDPcap,
           data = shg_exp)

# show results
summary(fit1)
summary(fit2)
summary(fit3)

# view diagnostic plot
plot(fit1)
plot(fit2)

# regression table
stargazer(fit1, fit2, fit3,
          type = "html",
          style = "apsr",
          out = "regressionTable.html")
```

The p-value should be smaller than 0.5. This is the case for all the three regression, whereby the value of the first model is quite high.

```{r starviewer_function}

# create wrapper around stargazer
starviewer <- function(...) {
  
  # make sure stargazer is available
  require(stargazer)
  
  # assume text output but check for latex or html
  star_format <- "text"
  if(knitr::is_latex_output()) {star_format <- "latex"}
  if(knitr::is_html_output())  {star_format <- "html"}
  
  # if latex, just run stargazer as usual
  if (star_format == "latex") {
    stargazer::stargazer(...)   

  } else {

  # if not latex, run stargazer in text / html (or both)  
    dir <- tempfile()
    dir.create(dir)
    htmlFile <- file.path(dir, "tempfile.html")
    stargazer::stargazer(..., type = star_format, out = htmlFile)
    rstudioapi::viewer(htmlFile)
  }
}

```


```{r create_table, results = 'asis'}
starviewer(fit1, fit2, fit3)

```
```


